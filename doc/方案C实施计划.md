# 方案C实施计划：修改范围与成本评估

## 一、修改范围概览

### 需要修改的文件（共4个）
1. `src/basics/flow/markdownPost.tsx` - 核心修改
2. `src/basics/ui/UIMultilineBlock.tsx` - 中等修改
3. `src/features/flow-editor/index.ts` - 轻度修改
4. `src/basics/codemirror/flowEditor.tsx` - 最小修改

### 不需要修改的文件
- `src/basics/enactor/enactor.ts`
- `src/basics/enactor/obsidian.tsx`
- 其他UI组件

## 二、具体修改内容

### 2.1 markdownPost.tsx（核心修改）

**修改点**：
1. 在`processMultilineEmbed`函数中添加DOM标记逻辑
2. 修改渲染前的检查逻辑
3. 简化React组件管理（移除复杂的Map管理）
4. 改进清理机制

**预计修改行数**：约80-100行
- 新增：40行（DOM检查和标记逻辑）
- 修改：30行（简化现有逻辑）
- 删除：30行（移除复杂的清理代码）

### 2.2 UIMultilineBlock.tsx（中等修改）

**修改点**：
1. 简化组件的状态管理
2. 从DOM属性读取渲染配置
3. 优化生命周期钩子
4. 移除不必要的重渲染逻辑

**预计修改行数**：约50-60行
- 修改：40行（简化状态和渲染逻辑）
- 删除：20行（移除冗余代码）

### 2.3 flow-editor/index.ts（轻度修改）

**修改点**：
1. 简化`handleModeSwitch`方法
2. 移除复杂的强制处理逻辑
3. 减少事件监听器

**预计修改行数**：约30-40行
- 主要是删除现有的复杂逻辑
- 保留基本的模式切换通知

### 2.4 flowEditor.tsx（最小修改）

**修改点**：
1. 移除对`![[]]`语法的支持（恢复到bak11之前）
2. 删除相关的调试日志

**预计修改行数**：约20行
- 主要是删除bak12添加的代码

## 三、实施步骤与风险

### 第一阶段（低风险）- 2小时
1. 恢复flowEditor.tsx到原始状态
2. 添加DOM标记逻辑
3. 测试基本功能

### 第二阶段（中风险）- 3小时
1. 修改processMultilineEmbed的核心逻辑
2. 实现缓存检查机制
3. 测试各种模式切换

### 第三阶段（低风险）- 1小时
1. 简化UIMultilineBlock组件
2. 清理冗余代码
3. 性能优化

## 四、成本评估

### 开发成本
- **总工时**：约6-8小时
- **代码改动**：约200行（净减少约50行）
- **复杂度**：中等（主要是理解现有逻辑）

### 测试成本
需要测试的场景：
1. Live Preview模式下的编辑/非编辑切换
2. Live -> Reading -> Live切换
3. 快速连续切换模式
4. 多个多行block同时存在
5. !![[]]可编辑块的功能

### 风险评估
- **低风险**：基本功能不会受影响
- **中风险**：某些边缘情况可能需要调试
- **可回退**：如果出现问题，可以快速回退到bak14

## 五、预期收益

### 技术收益
1. **代码量减少**：移除约50行复杂逻辑
2. **性能提升**：减少不必要的重渲染
3. **可维护性**：逻辑更清晰，易于理解

### 用户体验
1. **更流畅**：模式切换无闪烁
2. **更稳定**：避免空白问题
3. **更快速**：利用缓存提升性能

## 六、实施建议

1. **分阶段实施**：先做低风险修改，确认无误后再继续
2. **充分测试**：每个阶段都要测试主要场景
3. **保留回退方案**：创建新分支，保留当前代码
4. **逐步优化**：先解决核心问题，后续再优化细节

## 总结

方案C的实施成本适中，主要工作是简化现有的复杂逻辑，而不是添加新功能。通过利用DOM属性和Obsidian的缓存机制，可以用更少的代码实现更稳定的功能。